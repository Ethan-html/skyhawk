<!doctype html>
<html lang="en-US">
  <head>
    <title>Skyhawk Photo Gallery</title>
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta
      name="description"
      content="Skyhawk Composite Squadron builds youth leadership through Civil Air Patrol cadet programs, service, and aerospace education in Delano, MN."
    />

    <meta charset="utf-8" />
    <meta name="language" content="en-US" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="index,follow" />
    <meta name="googlebot" content="index,follow" />
    <meta name="msnbot" content="index,follow" />

    <link rel="canonical" href="https://skyhawk-cap.org/photos" />

    <!-- Social Sharing (OG + Twitter) -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Photo Gallery | Skyhawk Composite Squadron" />
    <meta
      property="og:description"
      content="Skyhawk Composite Squadron transforms youth into strong leaders through cadet programs, community service, and aerospace education in Delano, Minnesota."
    />
    <meta property="og:image" content="https://skyhawk-cap.org/assets/images/webclip.png" />
    <meta property="og:url" content="https://skyhawk-cap.org/photos" />
    <meta property="og:locale" content="en_US" />
    <meta property="article:author" content="https://www.facebook.com/capnhq/" />

    <meta property="twitter:card" content="summary" />
    <meta property="twitter:title" content="Photo Gallery | Skyhawk Composite Squadron" />
    <meta
      property="twitter:description"
      content="Skyhawk Composite Squadron transforms youth into strong leaders through cadet programs, community service, and aerospace education in Delano, Minnesota."
    />
    <meta property="twitter:image" content="https://skyhawk-cap.org/assets/images/webclip.png" />

    <!-- Favicon & App Icons -->
    <link rel="apple-touch-icon" href="/assets/images/webclip.png" />
    <link rel="manifest" href="/assets/manifest.json" />
    <link rel="icon" href="/media/website/skyhawks_logo_CAP_transparent.png" />
    <link
      rel="shortcut icon"
      href="/media/website/skyhawks_logo_CAP_transparent.png"
      type="image/png"
    />

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f2f3f4;
        color: black;
      }
      h1 {
        text-align: center;
      }
      #albums {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
        color: white;
      }
      .album {
        padding: 10px 20px;
        background: #222;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
        background: #333;
      }
      .gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }
      .thumb {
        width: 220px;
        height: 160px;
        border-radius: 8px;
        cursor: pointer;
        background: #222 url("/assets/images/noimg.png") center/cover no-repeat;
        /*transition: transform 0.2s, opacity 0.3s, background-image 0.3s;*/
      }
      /* Lightbox overlay */
      .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
      }
      .lightbox img {
        max-width: 90%;
        max-height: 80%;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      .lightbox a {
        color: white;
        text-decoration: none;
        font-size: 18px;
        background: #333;
        padding: 10px 20px;
        border-radius: 5px;
        transition: background 0.2s;
      }
      .lightbox a:hover {
        background: #555;
      }
      .lightbox.active {
        display: flex;
      }
      .black-line {
        border: none; /* remove default border */
        height: 4px; /* thickness */
        background-color: black; /* solid blue */
      }
      .album {
        flex: 1 1 140px;
        text-align: center;
        font-weight: bold;
      }
      #breadcrumbs {
        position: sticky;
        top: 0;
        background: #f2f3f4;
        padding: 10px 0;
        z-index: 5;
      }
      #folderNav select {
        padding: 8px 12px;
        margin: 5px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
      }
    </style>
    <script>
      var script = document.createElement("script");
      script.src = "/assets/js/config.js?t=" + new Date().getTime();

      script.onload = function () {
        import(
          "/assets/js/init.js" + (window.ASSET_VERSION ? "?v=" + window.ASSET_VERSION : "")
        ).then((m) => m.initPage());
      };

      document.head.appendChild(script);
    </script>
  </head>
  <body style="display: none">
    <div class="header-section">
      <div
        data-collapse="medium"
        data-animation="default"
        data-duration="400"
        class="nav-section w-nav"
      >
        <div class="header-contents-wrap">
          <div class="header-container w-container">
            <div class="logo-container">
              <a href="/" class="logo w-clearfix w-nav-brand">
                <img
                  src="/assets/images/CAP-2017-logo-horizontal-optimized.webp"
                  alt="Skyhawk Composite Squadron"
                  class="logo-image"
                />
              </a>
              <h2 class="website-tagline" id="unit-name"></h2>
            </div>
            <div class="header-content-right-wrap">
              <a href="/member" class="donations-btn">
                <div class="donations-btn-text">Back</div>
              </a>
              <div class="website-logo-container">
                <img
                  src="/media/website/skyhawks_logo_CAP_transparent.webp"
                  alt="Skyhawk Composite Squadron"
                  class="website-logo"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="w-nav-overlay" data-wf-ignore=""></div>
      </div>
    </div>
    <div class="black-line"></div>
    <br />
    <div id="main-page-content">
      <h1 class="visually-hidden">
        Skyhawk Composite Squadron â€“ Civil Air Patrol in Delano, Minnesota
      </h1>
      <h1>Skyhawk Photos</h1>
      <div id="folderNav" style="text-align: center; margin-bottom: 15px">
        <select id="photoTypeSelect">
          <option value="">Select Photo Type</option>
          <option value="meeting">Meeting Photos</option>
          <option value="promotion">Promotion Photos</option>
        </select>

        <select id="yearSelect" style="display: none">
          <option value="">Select Year</option>
        </select>
        <select id="monthSelect" style="display: none">
          <option value="">Select Month</option>
        </select>
        <select id="eventSelect" style="display: none">
          <option value="">Select Event</option>
        </select>

        <select id="cadetSelect" style="display: none">
          <option value="">Select Cadet</option>
        </select>
      </div>

      <div class="gallery" id="gallery"></div>
      <div id="lightbox" class="lightbox">
        <img id="lightbox-img" alt="Full photo" />
        <a id="download-btn" href="#" download>Download</a>
      </div>
    </div>
    <br /><br />
    <div id="footer"></div>
    <script>
      var _g = (window.SITE_CONFIG && window.SITE_CONFIG.github) || {};
      const OWNER = _g.owner || "Ethan-html";
      const REPO = _g.repo || "skyhawk-photos";
      const BRANCH = _g.branch || "main";
      const BATCH_SIZE = 50;

      let allFiles = [];
      let loadedCount = 0;
      let currentPath = "";
      const loadedThumbs = {};
      let folderCache = {};

      // IntersectionObserver for lazy-load
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const div = entry.target;
              const full = div.dataset.full;

              // Load high-res image in background
              const img = new Image();
              img.onload = () => (div.style.backgroundImage = `url('${full}')`);
              img.src = full;

              observer.unobserve(div);
            }
          });
        },
        { rootMargin: "200px" }
      );

      // Fetch albums (folders)
      const yearSelect = document.getElementById("yearSelect");
      const monthSelect = document.getElementById("monthSelect");
      const eventSelect = document.getElementById("eventSelect");
      const photoTypeSelect = document.getElementById("photoTypeSelect");
      const cadetSelect = document.getElementById("cadetSelect");

      async function fetchFolders(path = "") {
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
        try {
          const res = await fetch(url);
          const items = await res.json();
          if (!Array.isArray(items)) {
            console.error("GitHub API did not return an array:", items);
            return [];
          }
          return items.filter((i) => i.type === "dir");
        } catch (err) {
          console.error("Failed to fetch folders:", err);
          return [];
        }
      }

      async function fetchImages(path) {
        const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}?ref=${BRANCH}`;
        try {
          const res = await fetch(url);
          const items = await res.json();
          if (!Array.isArray(items)) {
            console.error("GitHub API did not return an array:", items);
            return [];
          }
          return items.filter((i) => i.type === "file" && i.name.match(/\.(jpg|jpeg|png|webp)$/i));
        } catch (err) {
          console.error("Failed to fetch images:", err);
          return [];
        }
      }
      photoTypeSelect.onchange = async () => {
        resetGallery();

        const type = photoTypeSelect.value;

        // Hide everything first
        yearSelect.style.display = "none";
        monthSelect.style.display = "none";
        eventSelect.style.display = "none";
        cadetSelect.style.display = "none";

        if (type === "meeting") {
          loadYears();
          yearSelect.style.display = "inline-block";
        }

        if (type === "promotion") {
          loadCadets();
          cadetSelect.style.display = "inline-block";
        }
      };

      function addOption(select, value, text) {
        const opt = document.createElement("option");
        opt.value = value;
        opt.textContent = text;
        select.appendChild(opt);
      }
      async function loadYears() {
        const years = await fetchFoldersCached("");

        yearSelect.innerHTML = "";
        addOption(yearSelect, "", "Select Year");

        years
          .filter((y) => y.name.toLowerCase() !== "promotion photos") // ðŸš« hide this
          .filter((y) => y.name.toLowerCase() !== "slideshow photos") // ðŸš« hide this
          .sort((a, b) => b.name.localeCompare(a.name))
          .forEach((y) => {
            addOption(yearSelect, y.name, y.name);
          });
      }
      async function loadCadets() {
        const cadetFolders = await fetchFoldersCached("promotion photos");

        cadetSelect.innerHTML = "";
        addOption(cadetSelect, "", "Select Cadet");

        cadetFolders
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((c) => {
            addOption(cadetSelect, c.name, c.name);
          });
      }
      cadetSelect.onchange = async () => {
        const cadet = cadetSelect.value;
        resetGallery();

        if (!cadet) return;

        const images = await fetchImages(`promotion photos/${cadet}`);

        // Sort in filename order (important for promotions)
        images.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

        allFiles = images;
        loadedCount = 0;
        loadNextBatch();
        window.addEventListener("scroll", onScroll);
      };

      yearSelect.onchange = async () => {
        const year = yearSelect.value;
        resetGallery();

        if (!year) return;

        const months = await fetchFoldersCached(year);
        monthSelect.style.display = "inline-block";
        monthSelect.innerHTML = "";
        addOption(monthSelect, "", "Select Month");

        months.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

        months.forEach((m) => {
          addOption(monthSelect, m.name, m.name);
        });

        eventSelect.style.display = "none";
      };
      monthSelect.onchange = async () => {
        const year = yearSelect.value;
        const month = monthSelect.value;
        resetGallery();

        if (!month) return;

        const events = await fetchFoldersCached(`${year}/${month}`);
        eventSelect.style.display = "inline-block";
        eventSelect.innerHTML = "";
        addOption(eventSelect, "", "Select Event");

        events.forEach((ev) => {
          addOption(eventSelect, ev.name, ev.name);
        });
      };
      eventSelect.onchange = async () => {
        const year = yearSelect.value;
        const month = monthSelect.value;
        const event = eventSelect.value;
        resetGallery();

        if (!event) return;

        const images = await fetchImages(`${year}/${month}/${event}`);
        allFiles = images;
        loadedCount = 0;
        loadNextBatch();
        window.addEventListener("scroll", onScroll);
      };

      function toCDN(url) {
        const parts = url.split("/");
        // ["https:", "", "raw.githubusercontent.com", OWNER, REPO, BRANCH, ...path]
        const owner = parts[3];
        const repo = parts[4];
        const branch = parts[5];
        const path = parts.slice(6).join("/");

        return `https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}/${path}`;
      }
      async function fetchFoldersCached(path = "") {
        if (folderCache[path]) return folderCache[path]; // return cached
        const folders = await fetchFolders(path);
        folderCache[path] = folders;
        return folders;
      }

      // Load next batch of images
      function loadNextBatch() {
        const gallery = document.getElementById("gallery");
        const batch = allFiles.slice(loadedCount, loadedCount + BATCH_SIZE);

        batch.forEach((file) => {
          const div = document.createElement("div");
          div.className = "thumb";
          div.dataset.full = toCDN(file.download_url);

          // Start preloading full image immediately
          const imgPrefetch = new Image();
          imgPrefetch.src = div.dataset.full;

          div.onclick = () => {
            const lightbox = document.getElementById("lightbox");
            const lightboxImg = document.getElementById("lightbox-img");
            const downloadBtn = document.getElementById("download-btn");

            lightboxImg.src = div.dataset.full; // instant lightbox load from CDN

            downloadBtn.onclick = async (e) => {
              e.preventDefault();
              const res = await fetch(div.dataset.full);
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = file.name;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            };

            lightbox.classList.add("active");
          };

          gallery.appendChild(div);
          loadedThumbs[file.name] = div;
          observer.observe(div);
        });

        loadedCount += batch.length;

        allFiles.slice(loadedCount, loadedCount + BATCH_SIZE).forEach((file) => {
          const img = new Image();
          img.src = toCDN(file.download_url);
        });

        if (gallery.scrollHeight < window.innerHeight && loadedCount < allFiles.length) {
          loadNextBatch();
        }
      }
      function resetGallery() {
        document.getElementById("gallery").innerHTML = "";
        allFiles = [];
        loadedCount = 0;
        window.removeEventListener("scroll", onScroll);
      }
      async function preloadAllFolders() {
        const years = await fetchFoldersCached(""); // top-level
        for (const y of years) {
          const months = await fetchFoldersCached(y.name);
          for (const m of months) {
            const events = await fetchFoldersCached(`${y.name}/${m.name}`);
          }
        }
      }
      preloadAllFolders();

      // Infinite scroll
      function onScroll() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
          if (loadedCount < allFiles.length) loadNextBatch();
        }
      }

      // Close lightbox
      document.getElementById("lightbox").onclick = (e) => {
        if (e.target.id === "lightbox" || e.target.id === "lightbox-img") {
          e.currentTarget.classList.remove("active");
        }
      };

      // Load default album on page load
      loadYears();
    </script>
  </body>
</html>
