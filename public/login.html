<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Skyhawk Squadron | Member Login</title>

    <meta name="description" content="Member login for Skyhawk Composite Squadron 47 Civil Air Patrol in Delano, Minnesota.">
    <link rel="canonical" href="https://skyhawk-cap.org/login">

    <!-- Icons -->
    <link rel="icon" href="/media/websites/skyhawks_logo_CAP_transparent.png" type="image/png">
    <link rel="apple-touch-icon" href="/assets/images/webclip.png">
    <link rel="manifest" href="/assets/manifest.json">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Member Login | Skyhawk Squadron">
    <meta property="og:description" content="Secure member login for Skyhawk Composite Squadron 47.">
    <meta property="og:image" content="https://skyhawk-cap.org/assets/images/webclip.png">
    <meta property="og:url" content="https://skyhawk-cap.org/login">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Member Login | Skyhawk Squadron">
    <meta name="twitter:description" content="Secure member login for Skyhawk Composite Squadron 47.">
    <meta name="twitter:image" content="https://skyhawk-cap.org/assets/images/webclip.png">

    <!-- Styles -->
    <link rel="stylesheet" href="/assets/stylesheets/main.css">

    <!-- Defer non-critical JS -->
    <script defer src="/assets/js/main-3e47b52a9c95aa9cd957b34befd0acf5.min.js"></script>

    <!-- Google Analytics (async is correct) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M2RSE2BRK2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-M2RSE2BRK2');
    </script>
  </head>
  <body>
    <div class="header-section">
      <div data-collapse="medium" data-animation="default" data-duration="400" class="nav-section w-nav">
        <div class="header-contents-wrap">
          <div class="header-container w-container">
            <div class="logo-container">
              <a href="/" class="logo w-clearfix w-nav-brand"> <img src="/assets/images/CAP-2017-logo-horizontal-optimized.webp" alt="Skyhawk Composite Squadron" class="logo-image"> </a>
              <h2 class="website-tagline" id="unit-name"></h2>
            </div>
            <div class="header-content-right-wrap">
              <div class="website-logo-container">
                <img src="/media/website/skyhawks_logo_CAP_transparent.webp" alt="Skyhawk Composite Squadron" class="website-logo">
              </div>
            </div>
          </div>
        </div>
        <div class="w-nav-overlay" data-wf-ignore=""></div>
      </div>
    </div>
    <div class="blue-line1"></div>
    <div class="login-page">
      <div class="login-card">
        <h2>Login to Your Account</h2>

        <form id="loginForm">
          <input type="email" id="username" placeholder="Email" required>
          <input type="password" id="password" placeholder="Password" required>
          <button type="submit">Login</button>
          <div class="error1" id="errorMsg" hidden></div>
        </form>

        <p class="login-links">
          <a href="#" id="forgot-password-link">Forgot your password?</a>
        </p>

        <div id="password-reset-section" class="hidden-section">
          <p>Enter your email to reset your password:</p>
          <input type="email" id="reset-email" placeholder="Enter your email">
          <button id="reset-password-btn">Send Reset Email</button>
          <div id="reset-status"></div>
          <p><a href="#" id="back-to-login">Back to login</a></p>
        </div>

        <div id="first-time-section" class="hidden-section">
          <input type="email" id="first-time-email" placeholder="Enter your email">
          <button id="first-time-reset-btn">Login</button>
          <div id="first-reset-status"></div>
        </div>

        <div id="first-time-reset-section" class="hidden-section">
          <h4>An <strong>email</strong> has been sent to set up your password.</h4>
          <p>Once you set your password, return here to log in.</p>
          <p>Didn't receive it? <a href="#" id="resend-reset-email">Resend email</a></p>
          <button onclick="window.location.href='/login'">Login</button>
        </div>

        <div class="login-footer">
          <p>Members only</p>
        </div>
      </div>
    </div>
    <div id="footer"></div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import { 
        getAuth,
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
        onAuthStateChanged
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
      import { initHeaderFooter } from "/assets/js/header-footer.js";


      const firebaseConfig = {
        apiKey: "AIzaSyBk_ikYB1PzkgHx4zJY73pe3EfzQRpZvqw",
        authDomain: "skyhawk-web.firebaseapp.com",
        projectId: "skyhawk-web",
        storageBucket: "skyhawk-web.firebasestorage.app",
        messagingSenderId: "340655139001",
        appId: "1:340655139001:web:7923a1fe83ac4a4c689368",
        measurementId: "G-M2RSE2BRK2"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const form = document.getElementById("loginForm");
      const errorMsg = document.getElementById("errorMsg");
      const params = new URLSearchParams(window.location.search);
      const isNew = params.has('new');
      const newEmail = params.get('new');

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;

        errorMsg.style.display = "block";
        errorMsg.style.color = "#333";
        errorMsg.textContent = "Signing in…";

        try {
          const userCredential = await signInWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // Check first login
          const { creationTime, lastSignInTime } = user.metadata;
          const isFirstLogin = creationTime === lastSignInTime;

          if (isFirstLogin) {
            // Force password reset via email
            await sendPasswordResetEmail(auth, email);
            alert("A password reset email has been sent. Please check your inbox to set your password.");
            await auth.signOut(); // prevent access until password is reset
            return; // stop further redirect
          }

          // Normal login
          errorMsg.style.color = "green";
          errorMsg.textContent = "Login successful! Redirecting…";

          setTimeout(() => {
            window.location.href = "/member"; // or "/member" if that’s your home page
          }, 800);

        } catch (err) {
          errorMsg.style.color = "red";

          switch (err.code) {
            case "auth/user-not-found":
              errorMsg.textContent = "No account found for this email.";
              break;
            case "auth/wrong-password":
              errorMsg.textContent = "Incorrect password.";
              break;
            case "auth/invalid-email":
              errorMsg.textContent = "Invalid email address.";
              break;
            default:
              errorMsg.textContent = "Login failed. Please try again.";
          }
        }
      });
      const loginForm = document.getElementById("loginForm");
      const forgotLink = document.getElementById("forgot-password-link");
      const resetSection = document.getElementById("password-reset-section");
      const firstTimeSection = document.getElementById("first-time-section");
      const backToLogin = document.getElementById("back-to-login");
      const resetEmailInput = document.getElementById("reset-email");
      const firstTimeEmailInput = document.getElementById("first-time-email");
      const resetStatus = document.getElementById("reset-status");
      const resetBtn = document.getElementById("reset-password-btn");
      const firstTimeResetBtn = document.getElementById("first-time-reset-btn");
      const firstResetStatus = document.getElementById("first-reset-status");
      const firstTimeResetSection = document.getElementById("first-time-reset-section");
      const resendResetLink = document.getElementById("resend-reset-email");

      resendResetLink.addEventListener("click", async (e) => {
        e.preventDefault();

        // Use the email from the first-time flow
        const email = firstTimeEmailInput.value.trim() || newEmail;

        if (!email) {
          alert("Missing email address. Please return to login.");
          return;
        }

        resendResetLink.textContent = "Sending…";
        resendResetLink.style.pointerEvents = "none";
        const actionCodeSettings = {
          url: "https://skyhawk-cap.org/login",
          handleCodeInApp: false, // default, but good to be explicit
        };
        try {
          await sendPasswordResetEmail(auth, email, actionCodeSettings);
          resendResetLink.textContent = "Email sent!";
        } catch (err) {
          console.error(err);
          resendResetLink.textContent = "Resend email";
          resendResetLink.style.pointerEvents = "auto";
          alert("Failed to resend email. Please try again.");
        }
      });

      if (isNew) {
        // Hide login form and forgot link
        loginForm.style.display = "none";
        forgotLink.style.display = "none";

        // Show first-time section
        firstTimeSection.style.display = "block";

        // Auto-fill the email input
        const firstTimeEmailInput = firstTimeSection.querySelector('input[type="email"]');
        firstTimeEmailInput.value = newEmail;

        // Focus the email input for convenience
        firstTimeEmailInput.focus();
      }
      forgotLink.addEventListener("click", (e) => {
        e.preventDefault();
        loginForm.style.display = "none";
        forgotLink.style.display = "none";
        resetSection.style.display = "block";
      });

      // Show login, hide reset form
      backToLogin.addEventListener("click", (e) => {
        e.preventDefault();
        resetSection.style.display = "none";
        loginForm.style.display = "block";
        forgotLink.style.display = "inline"; // show link again
        resetStatus.textContent = ""; // clear previous messages
        resetEmailInput.value = "";   // clear email input
      });

      resetBtn.addEventListener("click", async () => {
        const email = resetEmailInput.value.trim();
        if (!email) {
          resetStatus.style.color = "red";
          resetStatus.textContent = "Please enter your email address.";
          return;
        }

        resetStatus.style.color = "#333";
        resetStatus.textContent = "Sending password reset email…";
        const actionCodeSettings = {
          url: "https://skyhawk-cap.org/login",
          handleCodeInApp: false, // default, but good to be explicit
        };
        try {
          await sendPasswordResetEmail(auth, email, actionCodeSettings);
          resetStatus.style.color = "green";
          resetStatus.textContent = "Password reset email sent! Please check your inbox.";
          resetEmailInput.value = "";
        } catch (err) {
          console.error(err);
          resetStatus.style.color = "red";

          switch (err.code) {
            case "auth/user-not-found":
              resetStatus.textContent = "No account found with that email.";
              break;
            case "auth/invalid-email":
              resetStatus.textContent = "Invalid email address.";
              break;
            default:
              resetStatus.textContent = "Failed to send reset email. Please try again later.";
          }
        }
      });
      firstTimeResetBtn.addEventListener("click", async () => {
        const email = firstTimeEmailInput.value.trim();
        if (!email) {
          firstResetStatus.style.color = "red";
          firstResetStatus.textContent = "Please enter your email address.";
          return;
        }

        firstResetStatus.style.color = "#333";
        firstResetStatus.textContent = "Sending password reset email…";

        const actionCodeSettings = {
          url: "https://skyhawk-cap.org/login",
          handleCodeInApp: false, // default, but good to be explicit
        };

        try {
          await sendPasswordResetEmail(auth, email, actionCodeSettings);

          firstTimeSection.style.display = "none";
          firstTimeResetSection.style.display = "block";
        } catch (err) {
          console.error(err);
          firstResetStatus.style.color = "red";

          switch (err.code) {
            case "auth/user-not-found":
              firstResetStatus.textContent = "No account found with that email.";
              break;
            case "auth/invalid-email":
              firstResetStatus.textContent = "Invalid email address.";
              break;
            default:
              firstResetStatus.textContent =
                "Failed to send reset email. Please try again later.";
          }
        }
      });

      onAuthStateChanged(auth, (user) => {
        if (user && !isNew) {
          window.location.href = "/member";
        }
      });



      document.addEventListener("DOMContentLoaded", async () => {await Promise.all([initHeaderFooter(db)]);});
    </script>
  </body>
</html>
