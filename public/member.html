<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <title></title>
      <link rel="icon" type="image/png" href="/media/website/skyhawks_logo_CAP_transparent.png">
      <link rel="stylesheet" href="assets/stylesheets/main.css">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      
      <script src="https://skyhawk.cap.gov/core/libraries/jquery/assets/3.3.1/jquery.min.js"></script>
      <script src="https://skyhawk.cap.gov/assets/javascripts/main-3e47b52a9c95aa9cd957b34befd0acf5.min.js"></script>
      <script src="https://skyhawk.cap.gov/core/public/shared/assets/js/jquery.cycle2/2.1.6/jquery.cycle2-fef2f3645726cce4154911d6140d7d52.min.js"></script>
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-M2RSE2BRK2"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-M2RSE2BRK2');
      </script>
      <script type="module">
        // ===============================
        // FIREBASE INITIALIZATION
        // ===============================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import {
          initializeFirestore,
          persistentLocalCache,
          persistentMultipleTabManager,
          collection,
          doc,
          getDoc,
          getDocs
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import Glide from "https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/glide.esm.min.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBk_ikYB1PzkgHx4zJY73pe3EfzQRpZvqw",
          authDomain: "skyhawk-web.firebaseapp.com",
          projectId: "skyhawk-web",
          storageBucket: "skyhawk-web.firebasestorage.app",
          messagingSenderId: "340655139001",
          appId: "1:340655139001:web:7923a1fe83ac4a4c689368",
          measurementId: "G-M2RSE2BRK2"
        };

        const app = initializeApp(firebaseConfig);
        const db = initializeFirestore(app, {
          cache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
        });
        const auth = getAuth();

        // ===============================
        // CACHE-FIRST LOADERS
        // ===============================
        async function loadDocOrCache(pathSegments, cacheKey) {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            try { return JSON.parse(cached); } catch {}
          }
          try {
            const ref = doc(db, ...pathSegments);
            const snap = await getDoc(ref);
            if (snap.exists()) {
              const data = snap.data();
              localStorage.setItem(cacheKey, JSON.stringify(data));
              return data;
            }
          } catch (err) {
            console.warn(`Failed to load ${pathSegments.join("/")}`, err);
          }
          return null;
        }

        async function loadCollectionOrCache(pathSegments, cacheKey) {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            try { return JSON.parse(cached); } catch {}
          }
          try {
            const colRef = collection(db, ...pathSegments);
            const snap = await getDocs(colRef);
            const data = snap.docs.map(d => d.data());
            localStorage.setItem(cacheKey, JSON.stringify(data));
            return data;
          } catch (err) {
            console.warn(`Failed to load collection ${pathSegments.join("/")}`, err);
          }
          return [];
        }

        async function loadPage(sectionId, onUpdate) {
          const cacheKey = `pageData_${sectionId}`;
          const cachedRaw = localStorage.getItem(cacheKey);
          if (cachedRaw) {
            try { onUpdate(JSON.parse(cachedRaw)); } catch {}
          }
          const pageSnap = await getDoc(doc(db, "pages", sectionId));
          if (!pageSnap.exists()) return;
          const childrenSnap = await getDocs(collection(db, `pages/${sectionId}/children`));
          const fresh = { id: sectionId, title: pageSnap.data().title, children: {} };
          childrenSnap.forEach(c => {
            const d = c.data();
            fresh.children[d.slug] = {
              title: d.title,
              slug: d.slug,
              content: d.content,
              externalUrl: d.externalUrl || null
            };
          });
          if (JSON.stringify(fresh) !== cachedRaw) {
            localStorage.setItem(cacheKey, JSON.stringify(fresh));
            onUpdate(fresh);
          }
        }

        // ===============================
        // RENDER FUNCTIONS
        // ===============================
        function renderPage(pageData) {
          if (!pageData) return;
          const params = new URLSearchParams(location.search);
          const [, childSlug] = (params.get("page") || "").split("/");
          const children = Object.values(pageData.children);
          const active = children.find(c => c.slug === childSlug) || children[0];

          // Side nav
          const sideList = document.getElementById("sideNavList");
          const sideTitle = document.getElementById("sideNavTitleLink");
          sideTitle.textContent = pageData.title;
          sideTitle.href = `/page?page=${pageData.id}`;
          sideList.innerHTML = "";
          children.forEach(c => {
            const li = document.createElement("li");
            li.className = "left-nav-list-item";
            const a = document.createElement("a");
            a.className = "left-nav-list-link";
            a.href = `/page?page=${pageData.id}/${c.slug}`;
            a.textContent = c.title;
            if (c.slug === active.slug) a.classList.add("selected");
            li.append(a, document.createElement("div"));
            sideList.appendChild(li);
          });

          // Content
          document.getElementById("pageTitle").textContent = active.title;
          if (active.externalUrl) {
            location.href = active.externalUrl;
          } else {
            document.getElementById("pageContent").innerHTML = active.content;
          }
        }

        function renderUnit(unit) {
          if (!unit) return;
          document.title = unit.name;
          const el = document.getElementById("unit-name");
          if (el) el.textContent = `${unit.name} (${unit.designation})`;
        }

        function renderContact(contact) {
          if (!contact) return;
          const addrEl = document.getElementById("address");
          if (addrEl) addrEl.innerHTML = contact.address.replace(/\n/g, "<br>");
          const phoneEl = document.getElementById("phone");
          if (phoneEl) { phoneEl.href = `tel:${contact.phone}`; phoneEl.textContent = contact.phone; }
          const emailEl = document.getElementById("email");
          if (emailEl) { emailEl.innerHTML = `<a href="mailto:${contact.email}">${contact.email}</a>`; }
        }

        function renderQuickLinks(links) {
          if (!links?.length) return;
          const root = document.getElementById("footer-quick-links");
          if (!root) return;
          links.forEach(link => {
            const li = document.createElement("li");
            li.className = "footer-links-list-item";
            const a = document.createElement("a");
            a.className = "footer-link footer-list-item-link";
            a.href = link.url;
            a.textContent = link.title;
            a.target = link.external === "true" ? "_blank" : "_self";
            if (link.external === "true") a.rel = "noopener noreferrer";
            li.appendChild(a);
            root.appendChild(li);
          });
        }

        async function renderMenu() {
          const desktopRoot = document.getElementById("main-menu");
          const mobileRoot = document.getElementById("mobile-menu-root");

          if (!desktopRoot && !mobileRoot) return;

          // 1️⃣ Load cached menu immediately
          const cached = JSON.parse(localStorage.getItem("menuPages") || "null");
          if (cached) {
            if (desktopRoot) buildMenu(cached, desktopRoot);
            if (mobileRoot) buildMobileMenu(cached, mobileRoot);
          }

          // 2️⃣ Fetch fresh data
          try {
            const pagesCollection = collection("main", "menu", "pages");
            const pagesSnap = await getDocs(pagesCollection);

            const pagesWithChildren = await Promise.all(
              pagesSnap.docs.map(async pageDoc => {
                const childrenSnap = await getDocs(
                  collection(pagesCollection, pageDoc.id, "children")
                );
                return {
                  page: pageDoc.data(),
                  children: childrenSnap.docs.map(d => d.data())
                };
              })
            );

            localStorage.setItem("menuPages", JSON.stringify(pagesWithChildren));

            if (desktopRoot) {
              desktopRoot.innerHTML = "";
              buildMenu(pagesWithChildren, desktopRoot);
            }

            if (mobileRoot) {
              buildMobileMenu(pagesWithChildren, mobileRoot);
            }

          } catch (err) {
            console.warn("Failed to load menu", err);
          }
        }

        async function renderContentBoxes() {
          const container = document.querySelector(".cb-wrapper");
          if (!container) return;

          // Clear existing content
          container.innerHTML = "";

          // Fetch contentBoxes from Firebase
          const boxes = await loadCollectionOrCache(
            ["main", "contentBoxes", "children"], // path to the subcollection
            "contentBoxesChildren" // cache key
          );

          let counter = 0; // count boxes added
          boxes.forEach(box => {
            const a = document.createElement("a");
            a.href = box.url || "#";
            a.target = box.target || "_self";
            a.className = `custom-link cb ${box.position || "left"}`;

            const innerDiv = document.createElement("div");
            innerDiv.className = "cb-content w-clearfix";

            const headingDiv = document.createElement("div");
            headingDiv.className = "cb-text-heading";

            const span = document.createElement("span");
            span.textContent = box.title || "No Title";

            headingDiv.appendChild(span);

            const img = document.createElement("img");
            img.src = box.img || "";
            img.alt = box.title || "";
            img.loading = "lazy";
            img.className = "cb-image";

            innerDiv.appendChild(headingDiv);
            innerDiv.appendChild(img);
            a.appendChild(innerDiv);

            container.appendChild(a);

            counter++;

            // Insert clearBoth div after every 3 boxes
            if (counter % 3 === 0) {
              const clearDiv = document.createElement("div");
              clearDiv.className = "w--mehiddendium w-hidden-small w-hidden-tiny clearBoth";
              container.appendChild(clearDiv);
            }
          });


          // Optional: add clearBoth div for layout if needed
          const clearDiv = document.createElement("div");
          clearDiv.className = "w--mehiddendium w-hidden-small w-hidden-tiny clearBoth";
          container.appendChild(clearDiv);
        }

        async function renderMemberMenu() {
            const menuRoot = document.getElementById("member-menu");
            if (!menuRoot) return;

            let pagesData = JSON.parse(localStorage.getItem("menuPagesMember") || "null");
            if (pagesData) buildMenu(pagesData, menuRoot);

            try {
              const pagesCollection = collection(db, "member", "menu", "pages");
              const pagesSnap = await getDocs(pagesCollection);
              const pagesWithChildren = await Promise.all(
                pagesSnap.docs.map(async pageDoc => {
                  const childrenSnap = await getDocs(collection(pagesCollection, pageDoc.id, "children"));
                  return { page: pageDoc.data(), children: childrenSnap.docs.map(d => d.data()) };
                })
              );
              console.log('Member menu fetched from Firestore:', pagesWithChildren);

              localStorage.setItem("menuPagesMember", JSON.stringify(pagesWithChildren));
              menuRoot.innerHTML = "";
              buildMenu(pagesWithChildren, menuRoot);
            } catch (err) {
              console.warn("Failed to load member menu from Firestore", err);
            }
        }

        function buildMenu(pagesWithChildren, menuRoot) {
          const fragment = document.createDocumentFragment();
          pagesWithChildren.forEach(({ page, children }) => {
            const li = document.createElement("li");
            li.className = "main-li";
            li.id = `menu-item-${page.id || page.title}`;
            const a = document.createElement("a");
            a.href = page.url || "#";
            a.textContent = page.title;
            a.target = "_self";
            a.className = "main-nav-link";
            li.appendChild(a);
            if (children?.length) {
              li.classList.add("has-dropdown");
              const dropdown = document.createElement("div");
              dropdown.className = "dropdown-container";
              const ul = document.createElement("ul");
              ul.className = "dropdown-list";
              children.forEach(child => {
                const cli = document.createElement("li");
                const ca = document.createElement("a");
                ca.href = child.url || "#";
                ca.textContent = child.title;
                ca.target = "_self";
                cli.appendChild(ca);
                ul.appendChild(cli);
              });
              dropdown.appendChild(ul);
              li.appendChild(dropdown);
            }
            fragment.appendChild(li);
          });
          menuRoot.appendChild(fragment);
          if (window.jQuery) {
            jQuery('.main-li.has-dropdown').each(function () {
              const $item = jQuery(this);
              $item.off('mouseenter mouseleave');
              $item.on('mouseenter', () => $item.addClass('open'));
              $item.on('mouseleave', () => $item.removeClass('open'));
            });
          }
        }
        function buildMobileMenu(pagesWithChildren, root) {
          root.innerHTML = "";

          pagesWithChildren.forEach(({ page, children }) => {
            const li = document.createElement("li");
            li.setAttribute("data-breakpoints", "xs,sm,md,lg,xl");

            const a = document.createElement("a");
            a.className = "nav-link w-nav-link";
            a.setAttribute("data-breakpoints", "xs,sm,md,lg,xl");
            a.href = page.url || "#";
            a.textContent = page.title;

            li.appendChild(a);

            // ---- children ----
            if (children?.length) {
              const ul = document.createElement("ul");

              children.forEach(child => {
                const cli = document.createElement("li");
                cli.setAttribute("data-breakpoints", "xs,sm,md,lg,xl");

                const ca = document.createElement("a");
                ca.className = "nav-link w-nav-link";
                ca.setAttribute("data-breakpoints", "xs,sm,md,lg,xl");
                ca.href = child.url || "#";
                ca.textContent = child.title;

                cli.appendChild(ca);
                ul.appendChild(cli);
              });

              li.appendChild(ul);
            }

            root.appendChild(li);
          });
        }

        // ===============================
        // AUTH LOGOUT
        // ===============================
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try { await signOut(auth); window.location.replace("/"); }
            catch (err) { console.error("Logout failed:", err); }
          });
        }

        // ===============================
        // INIT
        // ===============================
        document.addEventListener("DOMContentLoaded", async () => {
          const sectionId = (new URLSearchParams(location.search).get("page") || "").split("/")[0];
          if (sectionId) document.getElementById("pageContent").textContent = "Loading...";
          
          const [unit, contact, quickLinks] = await Promise.all([
            loadDocOrCache(["main", "unit"], "unit"),
            loadDocOrCache(["main", "contact"], "contact"),
            loadCollectionOrCache(["main", "quickLinks", "children"], "quickLinks")
          ]);

          renderUnit(unit);
          renderContact(contact);
          renderQuickLinks(quickLinks);
          
          if (sectionId) loadPage(sectionId, renderPage);

          // Menu loads in background
          renderMenu();
          renderMemberMenu();
          await renderContentBoxes();
        });
            const menu = document.querySelector('.desktop-navigation-menu');


          // --------------------
        // Fetch slideshow URLs from Firebase
        // --------------------
        async function loadSlideshow() {
          try {
            const docRef = doc(db, "main", "slideshow");
            const snap = await getDoc(docRef);
            if (!snap.exists()) return [];

            const data = snap.data();
            if (!data.urls) return [];

            // Split comma-separated list and remove empty items
            return data.urls.split(",").map(u => u.trim()).filter(Boolean);
          } catch (err) {
            console.warn("Failed to load slideshow URLs:", err);
            return [];
          }
        }

        // --------------------
        // Render Glide.js slides dynamically
        // --------------------
        async function renderSlideshow() {
          const urls = await loadSlideshow();
          if (!urls.length) return;

          const slidesContainer = document.getElementById("glide-slides");
          urls.forEach(url => {
            const li = document.createElement("li");
            li.className = "glide__slide";
            const img = document.createElement("img");
            img.src = url;
            li.appendChild(img);
            slidesContainer.appendChild(li);
          });

          new Glide('#slideshow-container', {
            type: 'carousel',
            perView: 1,
            focusAt: 'center',
            gap: 0,
            autoplay: 5000,
            hoverpause: true,
          }).mount();
        }

        document.addEventListener("DOMContentLoaded", renderSlideshow);
        // --------------------
        // Render Copywrite Year
        // --------------------
        const el = document.getElementById("copyright-text");
        const year = new Date().getFullYear();

        el.innerHTML = `© ${year} Civil Air Patrol. All rights reserved.`;
      </script>
      <script src="assets/js/admin.js"></script>
   </head>
    <body style="display:none;">
      <script type="module">
        import { getAuth, onAuthStateChanged } 
          from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const auth = getAuth();

        // HARD GATE — no content allowed until auth resolves
        onAuthStateChanged(auth, user => {
          if (!user) {
            // Not logged in → go home
            window.location.replace("/");
          } else {
            // Authenticated → allow page to render
            document.body.style.display = "block";
          }
        });
      </script>
      <div class="header-section">
        <div data-collapse="medium" data-animation="default" data-duration="400" class="nav-section w-nav">
          <div class="header-contents-wrap">
            <div class="header-container w-container">
              <div class="logo-container">
                <a href="/" class="logo w-clearfix w-nav-brand"> <img src="/assets/images/CAP-2017-logo-horizontal-optimized.png" alt="Skyhawk Composite Squadron" class="logo-image"> </a>
                <h2 class="website-tagline" id="unit-name"></h2>
              </div>
              <div class="header-content-right-wrap">
                <button class="donations-btn" id="logoutBtn">Log out</button>
                <div class="website-logo-container">
                  <img src="/media/website/skyhawks_logo_CAP_transparent.png" alt="Skyhawk Composite Squadron" class="website-logo">
                </div>
              </div>
            </div>
            <nav class="header-menu-wrap">
              <div class="header-menu-inside-wrap">
                <div class="nav-container w-container">
                  <nav class="desktop-navigation-menu">
                    <ul class="main-ul" id="main-menu"></ul>
                  </nav>
                  <nav class="mobile-navigation-menu" aria-hidden="true">
                    <ul id="mobile-menu-root"></ul>
                  </nav>
                  <div class="menu-button w-clearfix w-nav-button mobile-menu-button">
                    <div class="menu-button-icon w-icon-nav-menu"></div>
                    <div class="menu-button-text">Menu</div>
                  </div>
                </div>
              </div>
            </nav>
            <div class="menu-divider"></div>
            <nav class="header-menu-wrap">
              <div class="header-menu-inside-wrap">
                <div class="nav-container w-container">
                  <nav class="desktop-navigation-menu">
                    <ul class="main-ul" id="member-menu"></ul>
                  </nav>
                  <div class="noMobile" style="display: none;">This Menu is Temporary Unavailable</div>
                </div>
              </div>
            </nav>
          </div>
          <div class="w-nav-overlay" data-wf-ignore=""></div>
        </div>
      </div>
      <div id="main-page-content">
        <section class="main-section">
          <div class="content-box-section-new">
            <div class="learn-more-heading"></div>
            <div class="content-box-section">
              <div id="join-button-container">
                <a href="/page?page=join/how-to-join/" class="donate-link w-inline-block">
                  <div class="donate-button-container">
                    <div class="donate-text">
                      <strong>JOIN</strong>
                    </div>
                    <img src="/assets/images/circle-arrow.png" class="donate-button" alt="">
                  </div>
                </a>
              </div>
              <div class="content-box-section-container"></div>
              <div class="cb-wrapper w-clearfix" id="content-boxes-wrapper"></div>
            </div>
          </div>
        </section>
      </div>
      <div class="footer-section">
        <div class="middle-footer-div">
          <div class="footer-container">
            <div class="footer-row row">
              <div class="_1 footer-column-wrap">
                <h4 class="footer-column-title">Address</h4>
                <p id="address" class="footer-paragraph"></p>
                <p class="footer-paragraph" x-ms-format-detection="none"><span id="phone"></span></p>
                <p id="email" class="footer-paragraph"></p>
              </div>
              <div class="_3 footer-column-wrap">
                <h4 class="footer-column-title">Mission Statement</h4>
                <div class="footer-paragraph">
                  Volunteers serving America's communities, saving lives, and shaping futures.
                </div>
              </div>
              <div class="_2 footer-column-wrap">
                <h4 class="footer-column-title">Quick Links</h4>
                <ul id="footer-quick-links" class="footer-links-list w-list-unstyled"></ul>
              </div>
            </div>
          </div>
          <div class="container footer w-container"></div>
          <div class="footer-signoff-section">
            <div class="bottom-footer-container">
              <div class="footer-signoff-row row w-row">
                <div class="column w-col w-col-9 w-col-stack">
                  <div id="copyright-text" class="copyright-text"></div>
                  <ul class="footer-signoff-list w-list-unstyled">
                    <li class="footer-signoff-list-item"><a href="https://get.adobe.com/reader/" target="_blank" rel="noopener" class="footer-link">Get Adobe Acrobat Reader</a></li>
                    <li class="footer-signoff-list-item"><a href="https://www.gocivilairpatrol.com/legal-privacy-statement" target="_blank" rel="noopener" class="footer-link">Legal &amp; Privacy Statement</a></li>
                  </ul>
                </div>
                <div class="devby column w-clearfix w-col w-col-3 w-col-stack">
                  <div class="footer-signoff-grip w-inline-block">
                    <div id="GRIPFooterLogo" style="padding-top: 10px;">
                      <span id="GRIPFooterLogoText" style="color: #919293; font-size: 10px; font-family: Arial, sans-serif; text-transform: uppercase; display: block; text-align: left; font-weight: 700; letter-spacing: 0.02rem;">
                        WEB DEVELOPMENT BY <a href="" target="_blank" rel="noopener noreferrer" style="color: #919293; text-decoration: underline;">ETHAN LARSON</a>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
   </body>
</html>